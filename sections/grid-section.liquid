{% schema %}
{
  "name": "Grid Section",
  "settings": [
    { "type": "product", "id": "product_1", "label": "Select Product 1" },
    { "type": "product", "id": "product_2", "label": "Select Product 2" },
    { "type": "product", "id": "product_3", "label": "Select Product 3" },
    { "type": "product", "id": "product_4", "label": "Select Product 4" },
    { "type": "product", "id": "product_5", "label": "Select Product 5" },
    { "type": "product", "id": "product_6", "label": "Select Product 6" }
  ],
  "presets": [{ "name": "Grid Section" }]
}
{% endschema %}

<div class="grid-section">
  <h2 class="section-title">Tisso vison in the wild</h2>

  <div class="product-grid">
    {% for p in (1..6) %}
      {% assign product_var = 'product_' | append: p %}
      {% assign prod_handle = section.settings[product_var] %}
      {% if prod_handle != blank %}
        {% assign product = all_products[prod_handle] %}
        {% if product %}
          <div class="product-item" data-product-handle="{{ product.handle }}">
            <img src="{{ product.featured_image | img_url: 'medium' }}" alt="{{ product.title }}">
            <div class="plus-icon">+</div>
          </div>
        {% endif %}
      {% endif %}
    {% endfor %}
  </div>
</div>

<!-- Popup Modal -->
<div id="product-popup" class="product-popup">
  <div class="popup-content">
    <span class="close-btn">&times;</span>
    <div class="popup-body">
      <img id="popup-image" src="" alt="">
      <div class="popup-details">
        <h3 id="popup-title"></h3>
        <p id="popup-price"></p>

        <!-- Color options (outside dropdown) -->
        <div class="color-options"></div>

        <!-- Size options (inside dropdown) -->
        <label for="size-select">Size:</label>
        <select id="size-select"></select>

        <button id="add-to-cart">Add to Cart</button>
      </div>
    </div>
  </div>
</div>

{% stylesheet %}
.grid-section {
  padding: 40px 20px;
  max-width: 1200px;
  margin: auto;
}
.grid-section .section-title {
  font-size: 28px;
  font-weight: 600;
  margin-bottom: 30px;
  text-align: left;
  padding-left: 10px;
}
.grid-section .product-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 32px;
}
.grid-section .product-item {
  position: relative;
  border-radius: 6px;
  box-shadow: 0 3px 16px rgba(0,0,0,0.08);
  overflow: hidden;
  cursor: pointer;
}
.grid-section .product-item img {
  width: 100%;
  border-radius: 6px;
  display: block;
}
.grid-section .plus-icon {
  position: absolute;
  top: 16px;
  right: 16px;
  width: 48px;
  height: 48px;
  background: #f4f4f4;
  border: 2.5px solid #232323;
  border-radius: 50%;
  font-size: 28px;
  font-weight: bold;
  line-height: 42px;
  text-align: center;
  cursor: pointer;
}
.product-popup {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
  z-index: 9999;
}
.popup-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 800px;
  width: 100%;
  display: flex;
  gap: 20px;
  position: relative;
}
.close-btn {
  position: absolute;
  top: 10px;
  right: 16px;
  font-size: 28px;
  cursor: pointer;
}
.popup-body {
  display: flex;
  gap: 20px;
}
.popup-body img {
  max-width: 300px;
  border-radius: 6px;
}
.popup-details {
  flex: 1;
}
.color-options {
  margin: 15px 0;
}
.color-options button {
  width: 28px;
  height: 28px;
  border: 2px solid #ddd;
  border-radius: 50%;
  margin-right: 8px;
  cursor: pointer;
}
#size-select {
  margin: 10px 0 20px;
  padding: 6px;
}
#add-to-cart {
  background: #232323;
  color: #fff;
  padding: 12px 20px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}
{% endstylesheet %}

{% javascript %}
document.addEventListener('DOMContentLoaded', function() {
  const plusIcons = document.querySelectorAll('.plus-icon');
  const popup = document.getElementById('product-popup');
  const closeBtn = document.querySelector('.close-btn');
  const popupImage = document.getElementById('popup-image');
  const popupTitle = document.getElementById('popup-title');
  const popupPrice = document.getElementById('popup-price');
  const colorOptions = document.querySelector('.color-options');
  const sizeSelect = document.getElementById('size-select');

  plusIcons.forEach(icon => {
    icon.addEventListener('click', async function() {
      const handle = this.closest('.product-item').dataset.productHandle;
      if (!handle) return;

      try {
        const response = await fetch(`/products/${handle}.js`);
        const product = await response.json();

        popupImage.src = product.featured_image;
        popupTitle.textContent = product.title;
        popupPrice.textContent = Shopify.formatMoney(product.price);

        // Reset options
        colorOptions.innerHTML = '';
        sizeSelect.innerHTML = '';

        // Group options
        product.options.forEach((option, index) => {
          if (option.name.toLowerCase().includes('color')) {
            option.values.forEach(value => {
              const btn = document.createElement('button');
              btn.style.background = value.toLowerCase();
              btn.title = value;
              colorOptions.appendChild(btn);
            });
          } else if (option.name.toLowerCase().includes('size')) {
            option.values.forEach(value => {
              const opt = document.createElement('option');
              opt.value = value;
              opt.textContent = value;
              sizeSelect.appendChild(opt);
            });
          }
        });

        popup.style.display = 'flex';
      } catch (err) {
        console.error('Error loading product:', err);
      }
    });
  });

  closeBtn.addEventListener('click', () => {
    popup.style.display = 'none';
  });

  popup.addEventListener('click', (e) => {
    if (e.target === popup) {
      popup.style.display = 'none';
    }
  });
});
{% endjavascript %}
